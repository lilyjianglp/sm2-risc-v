# RISC-V 64 位高性能 SM2 国密算法实现（汇编优化）

本项目实现了 **基于 RISC-V RV64 架构的 SM2 国密算法高性能实现**，  
核心有限域运算采用 **手写 RISC-V 汇编**，并与 C 语言实现进行性能对比分析。

所有优化 **仅基于 RV64 原生整数指令集**
（`mul / mulhu / add / sub / sltu`），  
**不依赖 SIMD / Vector / 特殊硬件扩展**，适用于通用 RISC-V 平台。

---

## ✨ 项目特性（Features）

- ✅ SM2 有限域核心运算的 RISC-V 汇编实现  
- ✅ 常量时间（Constant-Time）实现，避免侧信道泄露  
- ✅ C 实现 vs 汇编实现 **cycle 级性能对比**  
- ✅ 基于 `rdcycle` 的精确性能测量  
- ✅ 可在 QEMU RV64 user-mode 下直接运行

---

## 📊 性能测试结果（Benchmark Results）

**测试环境：**

- 架构：RV64（QEMU user-mode）
- 计时方式：`rdcycle` 读取 CPU cycle
- 测试方法：多轮重复 + 链式依赖，避免编译器/模拟器优化
- 结果：取多轮测试的平均值

| 运算模块 | C 实现 (cycles) | 汇编实现 (cycles) | 加速比 | 性能提升 |
|--------|----------------|------------------|--------|----------|
| 模乘 `fp_mul` | 371 | 209 | **1.77×** | 🔥 +77.6% |
| 模约减 `fp_reduce` | 343 | 249 | 1.38× | +37.3% |
| 模平方 `fp_sqr` | 358 | 275 | 1.30× | +30.2% |
| 模逆 `fp_inv` | 139,701 | 110,300 | 1.27× | +21.0% |
| 标量点乘 `[d]G` | 2,255,643 | 1,756,000 | 1.28× | +28.3% |
| SM2 KEX | 4,921,890 | 3,899,841 | 1.26× | +20.8% |

> 注：以上结果均为多轮测试的平均值。  
> 实验表明，**汇编层面对进位与寄存器的精确控制是性能提升的关键**。

---

## 📁 项目结构

```text
sm2-risc-v/
├── asm/                 # RISC-V 64 位汇编实现
│   ├── fp_add.S         # 模加（无分支进位链）
│   ├── fp_sub.S         # 模减（无分支借位链）
│   ├── fp_neg.S         # 模取负
│   ├── fp_mul.S         # 模乘（Comba 列式乘法）
│   ├── fp_sqr.S         # 模平方（对称优化）
│   └── fp_reduce.S     # SM2 快速模约减
├── fp.c                 # C 回退实现 + 汇编接口封装
├── fn.c                 # 大整数 / 有限域通用辅助函数
├── sm2_curve.c          # SM2 曲线参数与点运算
├── sm2_scalar.c         # 标量乘（窗口算法，常量时间）
├── sm2_kex.c            # SM2 密钥交换协议
├── test.c               # 性能基准测试（rdcycle）
├── Makefile             # 自动化构建与对比测试
└── README.md


<!--- ==================================================================== --->
快速开始（Usage）
1. 环境依赖
# RISC-V 交叉编译器
sudo apt install gcc-riscv64-linux-gnu
# RISC-V 模拟器（用户态）
sudo apt install qemu-user
2. 编译
项目使用 Makefile 管理，支持同时生成 纯 C 版本 和 汇编优化版本：
make
生成文件：
1.test_sm2_kex_c ：纯 C 基线版本
2.test_sm2_kex_rv ：RISC-V 汇编优化版本
3. 运行性能测试
make run
该命令将依次运行：
1.纯 C 实现（Baseline）
2.汇编优化实现（Optimized）
并输出详细的 cycle 统计结果。
<!---
==================================================================== --->
## 正确性验证

> **验证标准**：汇编实现 vs 参考 C 实现

* **功能等效性**：所有优化算子均通过 100% 覆盖测试，Benchmark 最终校验值 `[sink]` 完全相同。
* **侧信道防御**：底层实现保持 **常量时间（Constant-Time）** 执行，不引入任何数据相关的条件跳转。

<!--- ==================================================================== --->
作者：姜良萍 王奕文
方向：RISC-V / 国密算法SM2/ 密码工程
日期：2026-01-28
